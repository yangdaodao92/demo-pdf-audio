<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>得到</title>
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.38, minimum-scale=1.38, maximum-scale=1.38, user-scalable=no"/>-->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>
    <link href="/static/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .img-box{
            padding-bottom:100%;
        }
        .img-box img{
            /*position:absolute;*/
            top:0;
            bottom:0;
            left:0;
            right:0;
            width:100%;
            margin:auto;
        }
    </style>
</head>
<body>
<div>
    <div id="vue-content" style="padding: 5px">
        <div v-if="showBackIcon" style="position: fixed; z-index: 10000; bottom: 60px; left: 20px;
            font-size: 4rem; color: gray; opacity:0.5; cursor: pointer">
            <span class="glyphicon glyphicon-chevron-left" aria-hidden="true" @click="backHandler()"></span>
        </div>
        <!--音频-->
        <div style="display: flex; justify-content: center">
            <audio :autoplay="showList" v-for="obsKey in currentPageVo['audioList']" :src="obsKeyToPathMap[obsKey]" :tiggerLoad="audioSrc(obsKey)"
                   controls="controls" style="display: block; width: 100%; position: fixed; z-index: 10000; bottom: 10px;">
            </audio>
        </div>
        <!--列表-->
        <div v-show="showList">
            <ul class="list-group" v-for="(key, index) in Object.keys(pageVoList).sort()" :key="index">
                <li v-if="!pageVoList[key]['audioList']" @click="openPage(key)" class="list-group-item"
                    style="cursor: pointer">{{key}}</li>
                <li v-if="pageVoList[key]['audioList']" class="list-group-item"
                    style="display: flex; justify-content: space-between; align-items: center">
                    <span style="cursor: pointer" @click="openPage(key)">{{key}}</span>
                    <span style="font-size: 2rem" @click="playAudio(pageVoList[key]['audioList'])"
                          class="glyphicon glyphicon-play-circle" aria-hidden="true"></span>
                </li>
            </ul>
        </div>
        <div v-show="!showList">
            <!--pdf-->
            <iframe v-for="obsKey in currentPageVo['pdfList']" :src="obsKeyToPathMap[obsKey]" :tiggerLoad="pdfIframeSrc(obsKey)"
                    :style="{width: '100%', height: window.innerHeight + 'px'}"></iframe>
            <!--图片-->
            <div v-if="currentPageVo['pictureList']" :style="{height: window.innerHeight + 'px', overflowY: 'scroll', overflowScrolling: 'touch'}">
                <div class="img-box">
                    <img v-for="obsKey in currentPageVo['pictureList']" :src="obsKeyToPathMap[obsKey]" alt="加载中" :tiggerLoad="pictureSrc(obsKey)"
                         style="display: block">
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script src="/static/js/jquery.3.3.1.min.js" type="text/javascript"></script>
<script src="/static/js/vue.2.5.21.min.js" type="text/javascript"></script>
<script src="/static/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script>

    var vueContent = new Vue({
        el: '#vue-content',
        data: {
            catalogue: {},
            showList: true,
            paths: [], // 层次路径
            currentPageVo: {},
            obsKeyToPathMap: {}
        },
        methods: {
            openPage: function (key) {
                this.paths.push(key);
            },
            backHandler: function () {
                this.paths.pop();
                if (!this.showList) {
                    this.showList = true;
                }
            },
            audioSrc: function (obsKey) {
                let _this = this;
                $.post(`/assist/loadObs?obsKey=${obsKey}`, function (url) {
                    Vue.set(_this.obsKeyToPathMap, obsKey, url);
                });
            },
            pdfIframeSrc: function (obsKey) {
                let _this = this;
                $.post(`/assist/loadObs?obsKey=${obsKey}`, function (url) {
                    let pdfUrl = '/static/plugins/pdfJs/generic/web/viewer.html?file=' + encodeURIComponent(url);
                    Vue.set(_this.obsKeyToPathMap, obsKey, pdfUrl);
                });
            },
            pictureSrc: function (obsKey) {
                let _this = this;
                $.post(`/assist/loadObs?obsKey=${obsKey}`, function (url) {
                    Vue.set(_this.obsKeyToPathMap, obsKey, url);
                });
            },
            playAudio: function (audioList) {
                Vue.set(this.currentPageVo, 'audioList', audioList);
            }
        },
        computed: {
            pageVoList: function () {
                if (this.showList) {
                    let pageVoObj = Object.assign({}, this.catalogue);
                    for (let path of this.paths) {
                        pageVoObj = pageVoObj[path];
                    }

                    if (pageVoObj['audioList'] || pageVoObj['pdfList'] || pageVoObj['pictureList']) {
                        this.currentPageVo = pageVoObj;
                        this.showList = false;
                        return {};
                    } else {
                        return pageVoObj;
                    }
                }
            },
            showBackIcon: function () {
                return this.paths.length > 0;
            }
        }
    });

    // $.ajax({
    //     type: 'post',
    //     url: '/assist/loadAudio',
    //     data: {},
    //     dataType: 'text',
    //     success: function (data) {
    //         console.log(data)
    //
    //         var audio = $('#audio')[0];
    //         // audio.src = data;
    //
    //     }
    // });

    $.ajax({
        type: 'post',
        url: '/assist/loadCatalogue',
        data: {},
        success: function (catalogue) {
            vueContent.catalogue = catalogue;
        }
    });


</script>

</html>